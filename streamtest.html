<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Streaming Proxy Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        line-height: 1.6;
      }
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }
      textarea {
        width: 100%;
        height: 100px;
        margin-bottom: 10px;
        padding: 10px;
        font-size: 16px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      #output {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        white-space: pre-wrap;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>Streaming Proxy Test</h1>
    <textarea id="prompt" placeholder="Enter your prompt here..."></textarea>
    <br />
    <button id="send">Send</button>
    <div id="output"></div>

    <script>
      document.getElementById('send').addEventListener('click', async () => {
        const prompt = document.getElementById('prompt').value;
        const output = document.getElementById('output');
        output.textContent = ''; // Clear previous output
        let accumulatedText = '';

        if (!prompt) {
          output.textContent = 'Please enter a prompt.';
          return;
        }

        const response = await fetch('https://llm-test.abyzov.workers.dev/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'text/event-stream',
          },
          body: JSON.stringify({
            prompt: prompt,
            model_name: 'openai/gpt-4o-mini',
            stream: true,
          }),
        });

        if (!response.ok) {
          output.textContent = `Error: ${response.status} ${response.statusText}`;
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          buffer += chunk;

          let lines = buffer.split('\n');

          // Save the last (possibly incomplete) line back into buffer
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data:')) {
              const data = line.slice('data:'.length).trim();
              if (data === '[DONE]') {
                console.log('Stream finished');
                continue;
              }

              try {
                const parsedData = JSON.parse(data);
                const content = parsedData.choices[0]?.delta?.content || '';
                accumulatedText += content;
                output.textContent = accumulatedText;
              } catch (error) {
                console.error('Failed to parse message:', data);
              }
            }
          }
        }
      });
    </script>
  </body>
</html>
